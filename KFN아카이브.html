<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•œêµ­ì„ì—…ì‹ ë¬¸ ì•„ì¹´ì´ë¸Œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2d5016 0%, #4a7c59 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }

        .header h1 {
            color: #2d5016;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .header p {
            color: #666;
            font-size: 1.2em;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .upload-section, .archive-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .section-title {
            color: #333;
            margin-bottom: 25px;
            font-size: 1.8em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .upload-area {
            border: 3px dashed #ddd;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #4a7c59;
            background: #f8fff8;
        }

        .upload-area.dragover {
            border-color: #2d5016;
            background: #f0f8f0;
        }

        .upload-icon {
            font-size: 3em;
            color: #4a7c59;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #4a7c59;
        }

        .btn {
            background: linear-gradient(135deg, #2d5016 0%, #4a7c59 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s ease;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .file-list {
            margin-top: 20px;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: between;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .file-info {
            flex-grow: 1;
        }

        .file-name {
            font-weight: bold;
            color: #333;
        }

        .file-details {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .file-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .btn-view {
            background: #28a745;
            color: white;
        }

        .btn-view:hover {
            background: #218838;
        }

        .btn-download {
            background: #17a2b8;
            color: white;
        }

        .btn-download:hover {
            background: #138496;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .btn-delete:hover {
            background: #c82333;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #f0f0f0;
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #2d5016, #4a7c59);
            transition: width 0.3s ease;
        }

        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
        }

        .status-uploading {
            background: #d1ecf1;
            color: #0c5460;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .toast.show {
            transform: translateX(0);
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .container {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒ² í•œêµ­ì„ì—…ì‹ ë¬¸ ì•„ì¹´ì´ë¸Œ</h1>
            <p>êµ¬ë…ìë¥¼ ìœ„í•œ ê³¼ê±° ì‹ ë¬¸ ê²€ìƒ‰ ì„œë¹„ìŠ¤</p>
        </div>

        <div class="main-content">
            <!-- ì—…ë¡œë“œ ì„¹ì…˜ -->
            <div class="upload-section">
                <h2 class="section-title">
                    <span>ğŸ“¤</span> ì‹ ë¬¸ ì—…ë¡œë“œ
                </h2>

                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">ğŸ“</div>
                    <h3>PDF íŒŒì¼ì„ ì—¬ê¸°ë¡œ ëŒì–´ì˜¤ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”</h3>
                    <p>ì—¬ëŸ¬ íŒŒì¼ì„ í•œ ë²ˆì— ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
                    <input type="file" id="fileInput" multiple accept=".pdf" style="display: none;">
                </div>

                <div class="form-group">
                    <label for="publishDate">ë°œí–‰ì¼</label>
                    <input type="date" id="publishDate">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        ğŸ’¡ ë°œí–‰ì¼ì´ ì‹ ë¬¸ ì œëª©ì´ ë©ë‹ˆë‹¤ (ì˜ˆ: 2024ë…„ 1ì›” 15ì¼ í•œêµ­ì„ì—…ì‹ ë¬¸)
                    </small>
                </div>

                <div class="form-group">
                    <label for="title">íŠ¹ë³„ ì œëª© (ì„ íƒì‚¬í•­)</label>
                    <input type="text" id="title" placeholder="íŠ¹ë³„í•œ ì´ë²¤íŠ¸ë‚˜ ê¸°ë…í˜¸ì¸ ê²½ìš°ì—ë§Œ ì…ë ¥">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        ë¹„ì›Œë‘ë©´ "YYYYë…„ MMì›” DDì¼ í•œêµ­ì„ì—…ì‹ ë¬¸"ìœ¼ë¡œ ìë™ ìƒì„±ë©ë‹ˆë‹¤
                    </small>
                </div>

                <div class="form-group">
                    <label for="enableOCR">
                        <input type="checkbox" id="enableOCR" checked style="margin-right: 8px;">
                        OCR í…ìŠ¤íŠ¸ ì¶”ì¶œ (ê²€ìƒ‰ ê¸°ëŠ¥ í–¥ìƒ)
                    </label>
                    <small style="color: #666; display: block; margin-top: 5px;">
                        âœ¨ PDF ë‚´ìš©ì„ ë¶„ì„í•˜ì—¬ í‚¤ì›Œë“œ ê²€ìƒ‰ì´ ê°€ëŠ¥í•´ì§‘ë‹ˆë‹¤
                    </small>
                </div>

                <button class="btn" id="uploadBtn" disabled>ì—…ë¡œë“œ ì‹œì‘</button>

                <div class="file-list" id="selectedFiles"></div>
            </div>

            <!-- ì•„ì¹´ì´ë¸Œ ì„¹ì…˜ -->
            <div class="archive-section">
                <h2 class="section-title">
                    <span>ğŸ—ƒï¸</span> ë³´ê´€ëœ ì‹ ë¬¸
                </h2>

                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="ë‚ ì§œë‚˜ í‚¤ì›Œë“œë¡œ ê²€ìƒ‰... (ì˜ˆ: 2024-01, ì‚°ë¦¼, ëª©ì¬)">
                    <div style="margin-top: 8px; font-size: 0.9em; color: #666;">
                        ğŸ” <strong>ë˜‘ë˜‘í•œ ê²€ìƒ‰:</strong> ë‚ ì§œ(2024-01) ë˜ëŠ” PDF ë‚´ìš©ê¹Œì§€ ì°¾ì•„ë“œë ¤ìš”!
                    </div>
                </div>

                <div id="archiveList">
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸŒ²</div>
                        <h3>ì•„ì§ ì—…ë¡œë“œëœ ì‹ ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤</h3>
                        <p>ì™¼ìª½ì—ì„œ í•œêµ­ì„ì—…ì‹ ë¬¸ PDF íŒŒì¼ì„ ì—…ë¡œë“œí•´ë³´ì„¸ìš”</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- OCR ì§„í–‰ ìƒí™© ëª¨ë‹¬ -->
    <div id="ocrModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 40px; border-radius: 15px; text-align: center; max-width: 500px; width: 90%;">
            <div style="font-size: 3em; margin-bottom: 20px;">ğŸ¤–</div>
            <h3 style="margin-bottom: 15px;">PDF ë‚´ìš© ë¶„ì„ ì¤‘...</h3>
            <p id="ocrStatus" style="color: #666; margin-bottom: 20px;">í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•˜ê³  ìˆìŠµë‹ˆë‹¤</p>
            <div class="progress-bar" style="margin-bottom: 15px;">
                <div class="progress-fill" id="ocrProgress" style="width: 0%"></div>
            </div>
            <p style="font-size: 0.9em; color: #999;">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”. íŒŒì¼ í¬ê¸°ì— ë”°ë¼ ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>
    </div>

    <!-- í† ìŠ¤íŠ¸ ì•Œë¦¼ -->
    <div class="toast" id="toast"></div>

    <!-- PDF.js ë° Tesseract.js ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js"></script>
    
    <script>
        // ì „ì—­ ë³€ìˆ˜
        let selectedFiles = [];
        let archiveData = JSON.parse(localStorage.getItem('newspaperArchive') || '[]');
        
        // PDF.js ì›Œì»¤ ì„¤ì •
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // DOM ìš”ì†Œë“¤
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const selectedFilesDiv = document.getElementById('selectedFiles');
        const archiveList = document.getElementById('archiveList');
        const searchInput = document.getElementById('searchInput');
        const publishDate = document.getElementById('publishDate');
        const titleInput = document.getElementById('title');
        const enableOCR = document.getElementById('enableOCR');
        const ocrModal = document.getElementById('ocrModal');
        const ocrStatus = document.getElementById('ocrStatus');
        const ocrProgress = document.getElementById('ocrProgress');

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('drop', handleDrop);
        uploadArea.addEventListener('dragleave', handleDragLeave);
        fileInput.addEventListener('change', handleFileSelect);
        uploadBtn.addEventListener('click', handleUpload);
        searchInput.addEventListener('input', renderArchive);

        // íŒŒì¼ ì—…ë¡œë“œ ë²„íŠ¼ í™œì„±í™” ì²´í¬
        function checkUploadButton() {
            const hasFiles = selectedFiles.length > 0;
            const hasDate = publishDate.value !== '';
            
            uploadBtn.disabled = !(hasFiles && hasDate);
        }

        publishDate.addEventListener('change', checkUploadButton);

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì²˜ë¦¬
        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files).filter(file => file.type === 'application/pdf');
            addFiles(files);
        }

        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            addFiles(files);
        }

        // íŒŒì¼ ì¶”ê°€
        function addFiles(files) {
            files.forEach(file => {
                if (file.type === 'application/pdf') {
                    const fileObj = {
                        id: Date.now() + Math.random(),
                        file: file,
                        name: file.name,
                        size: (file.size / 1024 / 1024).toFixed(1) + 'MB',
                        status: 'ready'
                    };
                    selectedFiles.push(fileObj);
                }
            });
            
            renderSelectedFiles();
            checkUploadButton();
        }

        // ì„ íƒëœ íŒŒì¼ ëª©ë¡ ë Œë”ë§
        function renderSelectedFiles() {
            if (selectedFiles.length === 0) {
                selectedFilesDiv.innerHTML = '';
                return;
            }

            selectedFilesDiv.innerHTML = `
                <h4 style="margin-bottom: 15px;">ì„ íƒëœ íŒŒì¼ (${selectedFiles.length}ê°œ)</h4>
                ${selectedFiles.map(file => `
                    <div class="file-item">
                        <div class="file-info">
                            <div class="file-name">${file.name}</div>
                            <div class="file-details">${file.size}
                                ${file.ocrStatus ? `<br><small style="color: #007bff;">ğŸ¤– ${file.ocrStatus}</small>` : ''}
                            </div>
                            ${file.status !== 'ready' ? `
                                <div class="status ${file.status === 'success' ? 'status-success' : 'status-uploading'}">
                                    ${file.status === 'success' ? 'âœ… ì™„ë£Œ' : 'ğŸ“¤ ì—…ë¡œë“œ ì¤‘...'}
                                </div>
                            ` : ''}
                            ${file.progress !== undefined ? `
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${file.progress}%"></div>
                                </div>
                            ` : ''}
                        </div>
                        <div class="file-actions">
                            ${file.status === 'ready' ? `
                                <button class="btn-small btn-delete" onclick="removeFile('${file.id}')">ì‚­ì œ</button>
                            ` : ''}
                        </div>
                    </div>
                `).join('')}
            `;
        }

        // íŒŒì¼ ì œê±°
        function removeFile(fileId) {
            selectedFiles = selectedFiles.filter(f => f.id != fileId);
            renderSelectedFiles();
            checkUploadButton();
        }

        // PDFì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ (OCR)
        async function extractTextFromPDF(file) {
            try {
                showOCRModal();
                updateOCRStatus('PDF íŒŒì¼ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 10);

                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                const numPages = pdf.numPages;
                let fullText = '';

                updateOCRStatus(`ì´ ${numPages}í˜ì´ì§€ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤...`, 20);

                for (let pageNum = 1; pageNum <= numPages; pageNum++) {
                    updateOCRStatus(`${pageNum}/${numPages} í˜ì´ì§€ ì²˜ë¦¬ ì¤‘...`, 20 + (pageNum / numPages) * 60);
                    
                    const page = await pdf.getPage(pageNum);
                    
                    // 1. ë¨¼ì € PDFì˜ í…ìŠ¤íŠ¸ ë ˆì´ì–´ì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ ì‹œë„
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    
                    if (pageText.trim().length > 50) {
                        // í…ìŠ¤íŠ¸ ë ˆì´ì–´ê°€ ì¶©ë¶„í•œ ë‚´ìš©ì„ ê°€ì§€ê³  ìˆìœ¼ë©´ OCR ê±´ë„ˆë›°ê¸°
                        fullText += pageText + '\n\n';
                        continue;
                    }

                    // 2. í…ìŠ¤íŠ¸ ë ˆì´ì–´ê°€ ë¶€ì¡±í•˜ë©´ OCR ìˆ˜í–‰
                    const viewport = page.getViewport({scale: 2.0});
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    await page.render({
                        canvasContext: context,
                        viewport: viewport
                    }).promise;

                    // Canvasë¥¼ ì´ë¯¸ì§€ë¡œ ë³€í™˜í•˜ì—¬ OCR
                    const imageData = canvas.toDataURL('image/png');
                    
                    updateOCRStatus(`${pageNum}í˜ì´ì§€ í…ìŠ¤íŠ¸ ì¸ì‹ ì¤‘...`, 20 + (pageNum / numPages) * 70);
                    
                    try {
                        const result = await Tesseract.recognize(
                            imageData,
                            'kor+eng',
                            {
                                logger: m => {
                                    if (m.status === 'recognizing text') {
                                        const progress = Math.round(20 + (pageNum / numPages) * 70 + (m.progress * 10));
                                        updateOCRStatus(`${pageNum}í˜ì´ì§€ í…ìŠ¤íŠ¸ ì¸ì‹ ì¤‘... (${Math.round(m.progress * 100)}%)`, progress);
                                    }
                                }
                            }
                        );
                        
                        fullText += result.data.text + '\n\n';
                    } catch (ocrError) {
                        console.warn(`Page ${pageNum} OCR failed:`, ocrError);
                        fullText += pageText + '\n\n'; // í´ë°±ìœ¼ë¡œ í…ìŠ¤íŠ¸ ë ˆì´ì–´ ì‚¬ìš©
                    }
                }

                updateOCRStatus('í…ìŠ¤íŠ¸ ì¶”ì¶œ ì™„ë£Œ!', 100);
                hideOCRModal();
                
                return fullText.trim();
            } catch (error) {
                console.error('PDF í…ìŠ¤íŠ¸ ì¶”ì¶œ ì‹¤íŒ¨:', error);
                hideOCRModal();
                showToast('í…ìŠ¤íŠ¸ ì¶”ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. OCR ì—†ì´ ì§„í–‰í•©ë‹ˆë‹¤.', 'warning');
                return '';
            }
        }

        // OCR ëª¨ë‹¬ í‘œì‹œ/ìˆ¨ê¹€
        function showOCRModal() {
            ocrModal.style.display = 'flex';
        }

        function hideOCRModal() {
            ocrModal.style.display = 'none';
        }

        function updateOCRStatus(message, progress) {
            ocrStatus.textContent = message;
            ocrProgress.style.width = progress + '%';
        }

        // ë‚ ì§œë¥¼ í•œêµ­ì–´ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
        function formatKoreanDate(dateString) {
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            return `${year}ë…„ ${month}ì›” ${day}ì¼`;
        }

        // ì—…ë¡œë“œ ì²˜ë¦¬ (OCR í¬í•¨)
        async function handleUpload() {
            if (selectedFiles.length === 0) return;

            uploadBtn.disabled = true;
            uploadBtn.textContent = 'ì—…ë¡œë“œ ì¤‘...';

            for (let file of selectedFiles) {
                file.status = 'uploading';
                file.progress = 0;
                renderSelectedFiles();

                // OCR í…ìŠ¤íŠ¸ ì¶”ì¶œ
                let extractedText = '';
                if (enableOCR.checked) {
                    file.ocrStatus = 'OCR ë¶„ì„ ì¤‘...';
                    renderSelectedFiles();
                    extractedText = await extractTextFromPDF(file.file);
                }

                // ê°€ìƒì˜ ì—…ë¡œë“œ ì§„í–‰ë¥ 
                await simulateUpload(file);

                // ì•„ì¹´ì´ë¸Œì— ì¶”ê°€
                const archiveItem = {
                    id: file.id,
                    title: titleInput.value || `${formatKoreanDate(publishDate.value)} í•œêµ­ì„ì—…ì‹ ë¬¸`,
                    newspaper: 'forestry', // ê³ ì •ê°’
                    newspaperName: 'í•œêµ­ì„ì—…ì‹ ë¬¸',
                    date: publishDate.value,
                    filename: file.name,
                    size: file.size,
                    uploadDate: new Date().toISOString().split('T')[0],
                    fileData: await fileToBase64(file.file),
                    extractedText: extractedText, // OCR ê²°ê³¼ ì €ì¥
                    hasOCR: enableOCR.checked
                };

                archiveData.push(archiveItem);
                localStorage.setItem('newspaperArchive', JSON.stringify(archiveData));

                file.status = 'success';
                file.progress = 100;
                delete file.ocrStatus;
                renderSelectedFiles();
            }

            showToast(`${selectedFiles.length}ê°œ íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ! ${enableOCR.checked ? 'ğŸ“ OCR í…ìŠ¤íŠ¸ ì¶”ì¶œë„ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.' : ''} ğŸ‰`);
            
            // ì´ˆê¸°í™”
            setTimeout(() => {
                selectedFiles = [];
                renderSelectedFiles();
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'ì—…ë¡œë“œ ì‹œì‘';
                titleInput.value = '';
                renderArchive();
            }, 1500);
        }

        // ì—…ë¡œë“œ ì‹œë®¬ë ˆì´ì…˜
        function simulateUpload(file) {
            return new Promise(resolve => {
                let progress = 0;
                const interval = setInterval(() => {
                    progress += Math.random() * 25;
                    if (progress >= 100) {
                        progress = 100;
                        clearInterval(interval);
                        resolve();
                    }
                    file.progress = Math.min(progress, 100);
                    renderSelectedFiles();
                }, 200);
            });
        }

        // íŒŒì¼ì„ Base64ë¡œ ë³€í™˜ (ì‹¤ì œë¡œëŠ” ì„œë²„ì— ì €ì¥í•˜ê² ì§€ë§Œ ë°ëª¨ìš©)
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // ì•„ì¹´ì´ë¸Œ ë Œë”ë§ (OCR ê²€ìƒ‰ í¬í•¨)
        function renderArchive() {
            const searchTerm = searchInput.value.toLowerCase();
            const filteredData = archiveData.filter(item => {
                // ê¸°ë³¸ ê²€ìƒ‰ (ì œëª©, ë‚ ì§œ)
                const basicMatch = item.title.toLowerCase().includes(searchTerm) ||
                    item.date.includes(searchTerm);
                
                // OCR í…ìŠ¤íŠ¸ ê²€ìƒ‰
                const ocrMatch = item.extractedText && 
                    item.extractedText.toLowerCase().includes(searchTerm);
                
                return basicMatch || ocrMatch;
            });

            if (filteredData.length === 0) {
                archiveList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">${searchTerm ? 'ğŸ”' : 'ğŸŒ²'}</div>
                        <h3>${searchTerm ? 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤' : 'ì•„ì§ ì—…ë¡œë“œëœ ì‹ ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤'}</h3>
                        <p>${searchTerm ? 
                            'ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë¥¼ ì‹œë„í•´ë³´ì„¸ìš”<br><small>ğŸ’¡ ë‚ ì§œ(2024-01) ë˜ëŠ” PDF ë‚´ìš©ë„ ê²€ìƒ‰ë©ë‹ˆë‹¤!</small>' : 
                            'ì™¼ìª½ì—ì„œ í•œêµ­ì„ì—…ì‹ ë¬¸ PDF íŒŒì¼ì„ ì—…ë¡œë“œí•´ë³´ì„¸ìš”'}</p>
                    </div>
                `;
                return;
            }

            archiveList.innerHTML = filteredData.map(item => {
                // ê²€ìƒ‰ì–´ í•˜ì´ë¼ì´íŠ¸
                let highlightedTitle = item.title;
                let contentPreview = '';
                
                if (searchTerm && item.extractedText) {
                    // OCR í…ìŠ¤íŠ¸ì—ì„œ ê²€ìƒ‰ì–´ ì£¼ë³€ ë¬¸ë§¥ í‘œì‹œ
                    const textLower = item.extractedText.toLowerCase();
                    const termIndex = textLower.indexOf(searchTerm);
                    
                    if (termIndex !== -1) {
                        const start = Math.max(0, termIndex - 50);
                        const end = Math.min(item.extractedText.length, termIndex + searchTerm.length + 50);
                        contentPreview = '...' + item.extractedText.substring(start, end) + '...';
                        
                        // ê²€ìƒ‰ì–´ í•˜ì´ë¼ì´íŠ¸
                        const regex = new RegExp(`(${searchTerm})`, 'gi');
                        contentPreview = contentPreview.replace(regex, '<mark style="background: yellow;">$1</mark>');
                        highlightedTitle = item.title.replace(regex, '<mark style="background: yellow;">$1</mark>');
                    }
                }

                return `
                    <div class="file-item">
                        <div class="file-info">
                            <div class="file-name">${highlightedTitle}</div>
                            <div class="file-details">
                                ğŸŒ² í•œêµ­ì„ì—…ì‹ ë¬¸ â€¢ ${item.date} â€¢ ${item.size}
                                ${item.hasOCR ? ' â€¢ <span style="color: #28a745;">ğŸ“ ê²€ìƒ‰ê°€ëŠ¥</span>' : ''}
                                <br><small>ì—…ë¡œë“œ: ${item.uploadDate}</small>
                                ${contentPreview ? `<br><small style="color: #666; font-style: italic;">${contentPreview}</small>` : ''}
                            </div>
                        </div>
                        <div class="file-actions">
                            <button class="btn-small btn-view" onclick="viewPDF('${item.id}')">ë³´ê¸°</button>
                            <button class="btn-small btn-download" onclick="downloadPDF('${item.id}')">ë‹¤ìš´ë¡œë“œ</button>
                            <button class="btn-small btn-delete" onclick="deletePDF('${item.id}')">ì‚­ì œ</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // PDF ë³´ê¸°
        function viewPDF(id) {
            const item = archiveData.find(item => item.id == id);
            if (item && item.fileData) {
                const newWindow = window.open();
                newWindow.document.write(`
                    <html>
                        <head><title>${item.title}</title></head>
                        <body style="margin:0;">
                            <embed src="${item.fileData}" type="application/pdf" width="100%" height="100%">
                        </body>
                    </html>
                `);
            } else {
                showToast('íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
            }
        }

        // PDF ë‹¤ìš´ë¡œë“œ
        function downloadPDF(id) {
            const item = archiveData.find(item => item.id == id);
            if (item && item.fileData) {
                const link = document.createElement('a');
                link.href = item.fileData;
                link.download = item.filename;
                link.click();
                showToast('ë‹¤ìš´ë¡œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤');
            } else {
                showToast('íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
            }
        }

        // PDF ì‚­ì œ
        function deletePDF(id) {
            if (confirm('ì •ë§ë¡œ ì´ íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                archiveData = archiveData.filter(item => item.id != id);
                localStorage.setItem('newspaperArchive', JSON.stringify(archiveData));
                renderArchive();
                showToast('íŒŒì¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
            }
        }

        // í† ìŠ¤íŠ¸ ì•Œë¦¼
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            const colors = {
                success: '#28a745',
                error: '#dc3545', 
                warning: '#ffc107'
            };
            toast.style.background = colors[type] || colors.success;
            toast.style.color = type === 'warning' ? '#000' : '#fff';
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 4000);
        }

        // ì´ˆê¸° ë Œë”ë§
        renderArchive();
        
        // ì˜¤ëŠ˜ ë‚ ì§œë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
        publishDate.value = new Date().toISOString().split('T')[0];
    </script>
</body>
</html>